<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Attendance</title>
  <meta name="description" content="Attendance">

  <link rel="stylesheet" href="./css/vis-timeline-graph2d.min.css">

  <style type="text/css">
    body {
      color: #4D4D4D;
      font: 10pt arial;
    }
  </style>
</head>

<body onresize="/*timeline.checkResize();*/">

  <div id="visualization"></div>
  <input id="save" type="button" value="save">
  <input id="load" type="button" value="load">
  <input id="addMonimos" type="button" value="Προσθήκη Μόνιμου">
  <input id="addMiMonimos" type="button" value="Προσθήκη μη Μόνιμου">
  <input id="addEktosPN" type="button" value="Προσθήκη Εκτός ΠΝ">
  <textarea id="data"></textarea>

  <script src="./js/vis-timeline-graph2d.min.js"></script>
  <script>
  
    var sampleGroups = [
      {id: 1, content: 'Μόνιμοι', nestedGroups: [4, 5]},
      {id: 2, content: 'Μη Μόνιμοι', nestedGroups: [6, 7]},
      {id: 3, content: 'Εκτός ΠΝ', nestedGroups: [8, 9]},

      {id: 4, content: 'name1', treeLevel: 1},
      {id: 5, content: 'name2', treeLevel: 1},
      {id: 6, content: 'name3', treeLevel: 1},
      {id: 7, content: 'name4', treeLevel: 1},
      {id: 8, content: 'name5', treeLevel: 1},
      {id: 9, content: 'name6', treeLevel: 1}
    ]

    var sampleItems = [
      {
        "group": 4,
        "start": "2020-11-08",
        "end": "2020-11-13",
        "id": "1",
        "undefined": "1"
      },
      {
        "group": 5,
        "start": "2020-12-01",
        "end": "2020-12-10",
        "id": "2",
        "undefined": "2"
      },
      {
        "group": 6,
        "start": "2020-11-02",
        "end": "2020-11-10",
        "id": "3",
        "undefined": "3"
      },
      {
        "group": 6,
        "start": "2020-11-21",
        "end": "2020-11-28",
        "id": "4",
        "undefined": "4"
      },
      {
        "group": 8,
        "start": "2020-11-16",
        "end": "2020-11-22",
        "id": "5",
      },     
      {
        "group": 9,
        "start": "2020-11-16",
        "end": "2020-11-22",
        "id": "6",
      }
    ]

    var ektosCategory = sampleGroups.filter(obj => {
      return obj.content == "Εκτός ΠΝ"
    })[0];
    var ektosPN = sampleGroups.filter(obj => {
      return ektosCategory.nestedGroups.includes(obj.id)
    });
    for (var i = 0; i < ektosPN.length; i++) {
      ektosPN[i]["className"] = "ektos-pn";
    }
    var groups = new vis.DataSet(sampleGroups);

    sampleItems.forEach(item => {
      item.start = new Date(Date.parse(item.start));
      item.end = new Date(Date.parse(item.end));
    });
    var items = new vis.DataSet(sampleItems);

    function addDays(date, days) {
      var result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    function isParentGroup(group) {
      return group.hasOwnProperty("nestedGroups")
    }

    // specify options
    var options = {
      locale: 'el',
      stack: false,
      editable: {
        updateGroup: false,
        updateTime: true,
        overrideItems: true,
        remove: true,
        add: true
      },
      margin: {
        item: 10, // minimal margin between items
        axis: 5   // minimal margin between items and the axis
      },
      orientation: 'top',

      timeAxis: { scale: 'day', step: 1 },
      min: new Date(2020, 10, 1),  // lower limit of visible range
      max: new Date(2020, 11, 31),

      zoomable: false,
      zoomMin: 1000 * 60 * 60 * 24 * 31 * 2,  // two days (in milliseconds)
      zoomMax: 1000 * 60 * 60 * 24 * 31 * 3,  // 3 months

      snap: function (date, scale, step) {
        var days = 1000 * 60 * 60 * 24;
        return Math.round(date / days) * days - 1000 * 60 * 60 * 2;  // minus 2h (TZ adjustment)
      },
      // onUpdate: function (item, callback) {
      //   var update = prompt('Edit items text:', item.content);
      //   if (update === null) {
      //     callback(null);
      //   } else {
      //     item.content = update;
      //     callback(item);
      //   }
      // },
      onAdd(item, callback) {
        if (isParentGroup(groups.get(item.group))) {
          return;
        }
        item.end = addDays(item.start, 1);
        item.content = '';
        callback(item);
      },
      onMoving: function (item, callback) {
        var overlapping = items.get({
          filter: function(testItem) {
            return (
              (testItem.group == item.group) &&
              (testItem.id != item.id) &&
              (item.end >= testItem.start) &&
              (item.start <= testItem.end)
            )
          }
        });
        if (overlapping.length == 0) {
          callback(item);
        }
      }
    }

    // create a Timeline
    var container = document.getElementById('visualization');
    timeline = new vis.Timeline(container, null, options);
    timeline.setGroups(groups);
    timeline.setItems(items);
    timeline.on('click', function (properties) {
      //console.log(properties);
      var selectedGroup = groups.get(properties.group);
      if (isParentGroup(selectedGroup)) {
          return;
      }
      if (properties.what === "group-label") {
        groups.update({
          id: properties.group,
          content: prompt("Επεξεργασία") || selectedGroup.content,
          treeLevel: 1
        });
      }
    });

    var txtData = document.getElementById('data');

    document.getElementById('load').onclick = function loadData () {
      var data = JSON.parse(txtData.value);
      items.clear();
      items.add(data);
    };

    document.getElementById('save').onclick = function saveData() {
      // get the data from the DataSet
      //
      // Note that we specify the output type of the fields start and end
      // as "ISODate", which is safely serializable. Other serializable types
      // are "Number" (unix timestamp), "ASPDate" or "String" (without timezone!).
      //
      // Alternatively, it is possible to configure the DataSet to convert
      // the output automatically to ISODates like:
      //
      //   var options = {
      //     type: {start: 'ISODate', end: 'ISODate'}
      //   };
      //   var items = new vis.DataSet(options);
      //   // now items.get() will automatically convert start and end to ISO dates.
      //
      var data = items.get({
        type: {
          start: 'Number',
          end: 'Number'
        }
      });

      // serialize the data and put it in the textarea
      txtData.value = JSON.stringify(data, null, 2);
    }

    function addGroup(promptText, parentGroupContent) {
      groups.add({
        content: prompt(promptText),
        treeLevel: 1
      });
      var newIdAutoAssigned = groups.get()[groups.length - 1].id;
      groups.get({
        filter: function(group) {
          return group.content == parentGroupContent
        }
      })[0].nestedGroups.push(newIdAutoAssigned);
    }

    document.getElementById('addMonimos').onclick = () => addGroup('Όνομα Μόνιμου', 'Μόνιμοι')
    document.getElementById('addMiMonimos').onclick = () => addGroup('Όνομα Μη Μόνιμου', 'Μη Μόνιμοι')
    document.getElementById('addEktosPN').onclick = () => addGroup('Όνομα Εκτός ΠΝ', 'Εκτός ΠΝ')

    var ektos = document.querySelector(".vis-label.ektos-pn");

    for (var childDiv of Array.from(ektos.children)) {
      //childDiv.appendChild(document.createElement('input'));
      console.log(childDiv);
    }

  </script>

</body>
</html>
